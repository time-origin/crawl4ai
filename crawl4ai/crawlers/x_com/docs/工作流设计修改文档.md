# 工作流设计修改文档 (v2)

本文档根据最新的开发要求，重新梳理了 `crawl4ai` 服务需要新增的功能。此方案旨在**不修改现有核心逻辑**的基础上，增加新的任务控制流程。

核心目标：在爬取流程开始后，立即发送一个包含推文总数的消息，以便下游服务 `slm-trainer-rs` 能够预知任务规模。

---

## 1. `crawl4ai` (我方) 修改任务

**负责人**: 我方 Python 开发者

**核心原则**: **新增功能，不动旧逻辑**。原有的、将详细推文数据发送到 `x_com_scraped_data` 主题的流程保持不变，函数和变量名均不作修改。

**详细任务清单**:

1.  **接收任务ID**:
    *   **文件**: `crawl4ai/crawlers/x_com/production_crawler.py`
    *   **操作**: 在 `ArgumentParser` 中添加一个必需的命令行参数 `--original-task-id` (类型为 `int`)。

2.  **统计推文总数并发送控制消息**:
    *   **文件**: `crawl4ai/crawlers/x_com/production_crawler.py`
    *   **时机**: 在爬虫完成所有页面滚动，并收集到**所有推文的链接（或初步信息）之后**，并且在开始循环处理每个推文详情**之前**。
    *   **操作**:
        1.  获取收集到的推文链接列表的长度，得到推文总数 `total_tweets`。
        2.  调用一个**新封装的函数**（例如 `send_task_init_message`），将 `original_task_id` 和 `total_tweets` 传递给它。

3.  **实现新的发送函数**:
    *   **文件**: 建议在 `crawl4ai/crawlers/x_com/kafka_manager.py` (或处理Kafka通信的模块) 中实现。
    *   **函数名**: `send_task_init_message` (建议名)
    *   **逻辑**:
        1.  该函数接收 `original_task_id` 和 `total_tweets`。
        2.  构建一个字典（dict）对象，严格遵循以下结构：
            ```python
            {
              "type": "TASK_INIT",
              "original_task_id": original_task_id,
              "total_tweets": total_tweets
            }
            ```
        3.  将该字典序列化为 JSON 字符串。
        4.  使用 Kafka producer，将此 JSON 字符串作为消息，发送到**新的主题** `KAFKA_TASK_TOPIC` (`task_control_topic`)。
        5.  此消息只发送**一次**。

---

## 2. `slm-trainer-rs` (协作方) 修改任务

**负责人**: Rust 开发者

**主要任务概览**:
*   新增一个 Kafka 消费者，用于监听 `task_control_topic` 主题。
*   当收到 `TASK_INIT` 消息时，解析 `total_tweets` 和 `original_task_id`，并在 Redis 中初始化任务进度计数器。
*   原有的消费 `x_com_scraped_data` 主题的逻辑不变，只是在处理完每条消息后，需要去 Redis 中更新计数。

---

## 3. 共享数据结构 (The Contract)

*   **命令行参数**: `--original-task-id`
*   **Kafka 主题**:
    *   `task_control_topic` (**新增**): 用于发送 `TASK_INIT` 控制消息。
    *   `x_com_scraped_data` (**不变**): 用于发送详细推文数据。
*   **`task_control_topic` 消息格式**:
    ```json
    {
      "type": "TASK_INIT",
      "original_task_id": 123,
      "total_tweets": 450
    }
    ```

此方案确保了新功能的添加对现有系统的影响降到最低，只做加法，不做修改。
