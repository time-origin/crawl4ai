# 项目打包与执行指南

本文档提供两种部署和执行本项目的方式：使用 Docker（推荐）和打包为原生可执行文件。

---

## 一、使用 Docker 打包与执行 (推荐)

此方式通过 Docker 容器进行部署，环境隔离性好，是生产环境的首选方案。

### 1. 打包项目 (构建镜像)

在项目根目录 (`crawl4ai`) 下打开终端，并执行以下命令来构建镜像：

```sh
docker build -t custom-crawl4ai -f Dockerfile-custom .
```

### 2. 执行爬虫

构建好镜像后，你可以使用 `docker run` 命令来启动一个容器并执行爬虫任务。

**示例 1: 基本执行**
```sh
docker run --rm -it custom-crawl4ai python -m crawl4ai.crawlers.x_com.production_crawler --keyword "OpenAI"
```

**示例 2: 带全参数执行**
```sh
docker run --rm -it custom-crawl4ai python -m crawl4ai.crawlers.x_com.production_crawler \
    --keyword "generative AI" \
    --scan-scrolls 3 \
    --max-replies 10 \
    --reply-scrolls 8 \
    --output-method kafka \
    --kafka-key-prefix "x.com"
```

---

## 二、打包为完全独立的可执行文件 (高级)

此方法可以将项目（包括 Python 解释器、所有依赖库和 Playwright 浏览器）打包成一个**单文件可执行程序**。这使得程序可以**在任何未安装 Python 或浏览器的目标机器上直接运行**，真正实现“开箱即用”。

**注意：** 此方法会将数百 MB 的浏览器文件打包进去，导致最终生成的可执行文件体积非常大。

### 第1步：环境准备 (打包机器)

在你的开发机器上，需要先安装 `pyinstaller` 和 `playwright`，并下载 Playwright 所需的浏览器。

```sh
# 安装 PyInstaller 和 Playwright
pip install pyinstaller playwright

# 下载浏览器 (只需执行一次)
playwright install
```

### 第2步：查找依赖路径 (关键步骤)

在执行打包命令之前，你必须先找到两个重要的路径。

#### 2.1 查找 Playwright 浏览器路径

在你的项目终端中运行以下命令，找到 `ms-playwright` 文件夹的绝对路径：

```sh
python -c "from playwright.sync_api import sync_playwright; from pathlib import Path; p=sync_playwright().start(); print(Path(p.chromium.executable_path).parent.parent.parent); p.stop()"
```

**可能的输出示例:** `C:\Users\Administrator\AppData\Local\ms-playwright`

#### 2.2 查找 Python 核心库路径 (仅限 Windows)

为了解决 `_ssl` 等底层模块加载失败的问题，我们需要找到 Python 环境的核心库文件夹。在终端中运行以下命令，找到你的 Python 安装根目录：

```sh
python -c "import sys; print(sys.base_prefix)"
```

**可能的输出示例 (Conda 环境):** `D:\python\anaconda3`

### 第3步：执行打包命令 (最终决战版)

在项目根目录 (`crawl4ai`) 下，根据你的目标操作系统执行以下命令。此命令包含了处理所有已知依赖库数据文件、模块路径和底层DLL依赖的参数。

#### Windows 打包命令:

```shell
pyinstaller --onefile --name production_crawler_win --paths . --collect-all playwright --collect-data fake_http_header --collect-data playwright_stealth --add-data "<path_to_your_ms-playwright>;ms-playwright" --add-binary "<path_to_your_python_prefix>\DLLs;DLLs" --add-binary "<path_to_your_python_prefix>\Library\bin;." crawl4ai/crawlers/x_com/production_crawler.py
```

**Windows 示例 (使用第2步找到的路径):**
```shell
pyinstaller --onefile --name production_crawler_win --paths . --collect-all playwright --collect-data fake_http_header --collect-data playwright_stealth --add-data "C:\Users\Administrator\AppData\Local\ms-playwright;ms-playwright" --add-binary "D:\python\anaconda3\DLLs;DLLs" --add-binary "D:\python\anaconda3\Library\bin;." crawl4ai/crawlers/x_com/production_crawler.py
```

*   **重要提示**: `--collect-all playwright` 是解决 Playwright 自身驱动找不到问题的关键。

#### Linux / macOS 打包命令:

```shell
pyinstaller --onefile --name production_crawler_linux --paths . --collect-all playwright --collect-data fake_http_header --collect-data playwright_stealth --add-data "<path_to_your_ms-playwright>:ms-playwright" crawl4ai/crawlers/x_com/production_crawler.py
```

打包完成后，最终的可执行文件会存放在项目根目录的 `dist` 文件夹下。

### 第4步：部署和执行

部署过程不变：

1.  将 `dist` 文件夹下生成的可执行文件（例如 `production_crawler_win.exe`）复制到任何目标机器上。
2.  在该可执行文件旁边创建一个 `.env` 文件，用于配置程序（如 Kafka 地址、代理等）。

#### 执行命令

在目标机器上打开命令行工具，进入可执行文件所在的目录，然后像普通程序一样运行它。

**在 Windows 上:**

```shell
# 示例 1: 基本执行
.\production_crawler_win.exe --keyword "OpenAI"

# 示例 2: 带全参数执行
.\production_crawler_win.exe --keyword "generative AI" --scan-scrolls 3 --max-replies 10 --reply-scrolls 8 --output-method kafka --kafka-key-prefix "x.com"
```

**在 Linux 上:**

首先，给文件添加执行权限：
```shell
chmod +x ./production_crawler_linux
```

然后执行：
```shell
# 示例 1: 基本执行
./production_crawler_linux --keyword "OpenAI"

# 示例 2: 带全参数执行
./production_crawler_linux --keyword "generative AI" --scan-scrolls 3 --max-replies 10 --reply-scrolls 8 --output-method kafka --kafka-key-prefix "x.com"
```
