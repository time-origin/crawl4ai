# X.com (Twitter) 数据抓取功能开发与测试文档

## 1. 概述

### 1.1. 目标

本文档旨在为开发和测试 `x.com` 数据抓取功能提供指导。该功能旨在解决直接请求 `x.com` 页面返回空内容的问题，通过模拟真实用户行为来获取所需数据。

### 1.2. 问题背景

`x.com` 是一个动态的、重度依赖 JavaScript 的单页应用 (SPA)，并强制要求用户登录才能访问绝大部分内容。因此，传统的 HTTP 抓取方法无法获取有效数据。本项目将采用无头浏览器自动化技术来克服这些障碍。

## 2. 开发方案

### 2.1. 技术选型

*   **核心库**: Playwright (推荐) 或 Selenium。Playwright 提供了一流的自动化能力和更现代的 API。
*   **编程语言**: Python
*   **依赖管理**: `requirements.txt`

### 2.2. 核心开发步骤

#### 2.2.1. 环境配置

开发者需要在环境中安装所选的浏览器自动化库。

```bash
# 使用 Playwright
pip install playwright
python -m playwright install

# 使用 Selenium
# pip install selenium
```

#### 2.2.2. 认证与会话管理

为了避免每次抓取都重新登录（这很容易被识别为机器人行为），我们需要管理登录会话。

1.  **首次登录**:
    *   通过自动化浏览器，导航到登录页面。
    *   使用准备好的 `x.com` 账户凭据（用户名、密码）填充表单并提交。
    *   **强烈建议将凭据存储在环境变量或安全的配置中心，而不是硬编码在代码中。**
2.  **保存会话状态**:
    *   登录成功后，使用 Playwright 的 `browser.new_context(storage_state="state.json")` 或 Selenium 的 `driver.get_cookies()` 来保存认证后的会话信息（Cookies、LocalStorage）。
3.  **复用会话**:
    *   在后续的抓取任务中，直接加载已保存的会话状态，从而跳过登录步骤，使抓取更高效、更隐蔽。

#### 2.2.3. 数据抓取逻辑

1.  **初始化**: 使用已保存的会话状态启动浏览器上下文。
2.  **导航**: `page.goto(url)` 导航到目标页面（例如，用户主页、特定推文链接）。
3.  **等待内容加载**: **这是关键一步**。必须等待页面动态内容加载完成。使用 `page.wait_for_selector()` 或 `page.wait_for_load_state('networkidle')` 等待特定元素出现或网络活动停止。
4.  **数据提取**:
    *   使用 `page.locator()` 或 `page.query_selector_all()` 配合 CSS 选择器或 XPath 来定位包含所需数据的 HTML 元素。
    *   提取元素的文本、属性（如 `href`）等信息。
    *   示例：抓取用户时间线上的所有推文文本。
5.  **错误处理与重试**:
    *   实现对网络错误、元素未找到、验证码出现等异常情况的捕获。
    *   设计合理的重试机制（例如，带指数退避的重试），并设置最大重试次数。

### 2.3. 数据结构

定义清晰的、标准化的数据输出格式。例如，对于一条推文，可以定义如下 JSON 结构：

```json
{
  "tweet_id": "1234567890",
  "author_username": "example_user",
  "created_at": "2023-10-27T10:00:00Z",
  "text": "This is a sample tweet.",
  "url": "https://x.com/example_user/status/1234567890"
}
```

## 3. 测试文档

### 3.1. 测试环境

*   与开发环境一致，需要安装好浏览器和自动化库。
*   准备一个专用于测试的 `x.com` 账号。

### 3.2. 测试用例

| **用例 ID** | **测试模块** | **测试描述** | **前置条件** | **预期结果** |
| :--- | :--- | :--- | :--- | :--- |
| **TC-X-001** | **登录** | 测试使用有效的凭据能否成功登录并保存会话状态。 | 准备好有效的用户名和密码。 | 脚本执行成功，并生成 `state.json` 文件。 |
| **TC-X-002** | **登录** | 测试使用无效的凭据登录。 | 准备好无效的用户名或密码。 | 脚本应抛出认证失败的异常，而不是崩溃。 |
| **TC-X-003** | **会话复用** | 测试能否使用已保存的会话文件跳过登录直接访问用户页面。 | `state.json` 文件存在且有效。 | 脚本成功导航到需登录才能访问的页面。 |
| **TC-X-004** | **数据抓取** | 测试抓取一个公开的用户主页。 | 有效会话。 | 成功提取该用户最新的 N 条推文，数据格式符合定义。 |
| **TC-X-005** | **数据抓取** | 测试抓取一个不存在的用户主页。 | 有效会话。 | 脚本应能处理“页面未找到”的情况，并返回空结果或相应提示。 |
| **TC-X-006** | **数据抓取** | 测试抓取一条具体的推文链接。 | 有效会话。 | 成功提取该推文的内容、作者等信息。 |
| **TC-X-007** | **边界情况** | 测试抓取一个受保护（私密）账号的页面。 | 使用未关注该账号的测试账号会话。 | 脚本应返回空结果或提示“无权访问”。 |

### 3.3. 部署与维护注意事项

*   **代理IP**: 为避免 IP 被封锁，在生产环境中应使用代理 IP 池，并为每次请求轮换 IP。
*   **监控与告警**: `x.com` 的前端结构可能会变化，导致选择器失效。需要建立监控机制，定期检查抓取成功率，并在失败率超过阈值时发送告警。
*   **遵守规则**: 尊重 `robots.txt` 协议，并避免过于频繁的抓取，以免对目标服务器造成过大压力。
