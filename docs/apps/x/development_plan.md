# X.com 抓取功能开发顺序清单

本清单旨在提供一个清晰、分步的开发路线图，以确保 `x.com` 抓取功能的顺利实现。

---

### **第一步：环境搭建与项目初始化**

*   **任务**:
    1.  创建项目目录结构。
    2.  初始化 Python 虚拟环境。
    3.  安装核心依赖库：`playwright`。
    4.  执行 `python -m playwright install` 下载浏览器驱动。
    5.  创建主程序入口文件（例如 `main.py`）和配置文件（用于存放账号等敏感信息）。
*   **产出**: 一个可以运行 Playwright 脚本的基础项目框架。

---

### **第二步：实现登录与会话管理**

*   **任务**:
    1.  编写一个独立的脚本 `login.py`。
    2.  该脚本使用 Playwright 启动一个**有头**浏览器（非无头，便于观察和调试）。
    3.  自动导航到 `x.com` 登录页面。
    4.  从配置文件或环境变量中读取用户名和密码，填充登录表单并提交。
    5.  **手动处理可能出现的验证码或二次验证**。
    6.  登录成功后，将浏览器的会话状态（`storage_state`）保存到一个固定的文件，例如 `auth_state.json`。
*   **产出**: 一个 `auth_state.json` 文件，包含了有效的登录凭证。

---

### **第三步：开发核心抓取模块**

*   **任务**:
    1.  创建一个 `scraper.py` 模块。
    2.  编写一个核心抓取函数 `scrape_page(url)`。
    3.  此函数启动一个**无头**浏览器。
    4.  **加载 `auth_state.json` 文件**来创建一个已认证的浏览器上下文，从而跳过登录。
    5.  导航到传入的 `url`。
    6.  实现健壮的等待机制，例如 `page.wait_for_selector('article[data-testid="tweet"]')`，确保推文内容已动态加载。
    7.  初步提取页面的原始 HTML 或特定区域的文本内容并返回。
*   **产出**: 一个可以利用已有会话抓取指定 URL 并返回页面内容的函数。

---

### **第四步：实现具体页面的数据解析**

*   **任务**:
    1.  基于第三步的抓取函数，编写专门的解析函数。
    2.  **解析用户主页**: 创建 `parse_user_timeline(html)` 函数，使用 CSS 选择器从页面 HTML 中提取多条推文的作者、内容、时间、链接等信息。
    3.  **解析单条推文页面**: 创建 `parse_single_tweet(html)` 函数，提取单条推文的详细信息。
    4.  将提取的数据转换为标准化的 JSON 格式。
*   **产出**: 能够将抓取到的 HTML 页面转化为结构化 JSON 数据的解析函数。

---

### **第五步：构建错误处理与重试机制**

*   **任务**:
    1.  在核心抓取函数 `scrape_page` 中加入 `try...except` 块。
    2.  捕获常见异常，如 `TimeoutError` (等待元素超时)、网络错误等。
    3.  实现一个简单的重试逻辑：当捕获到可重试的异常时，等待一段时间后重新尝试抓取，并设置最大重试次数。
*   **产出**: 一个更稳定、能够应对临时网络波动或页面加载延迟的抓取器。

---

### **第六步：编写与执行测试**

*   **任务**:
    1.  根据之前创建的测试文档，编写自动化测试脚本。
    2.  **测试登录**: 运行 `login.py` 确保可以生成会话文件。
    3.  **测试抓取**: 编写测试用例，调用 `scrape_page` 和解析函数，传入不同的 URL（正常用户页、不存在的用户页、单条推文链接），断言返回的数据是否符合预期。
    4.  **测试边界情况**: 测试抓取私密账号（预期应失败或返回空）。
*   **产出**: 一套可以验证核心功能正确性的测试用例。

---

### **第七步：生产环境优化（可选，但强烈建议）**

*   **任务**:
    1.  **集成代理**: 修改抓取模块，使其可以通过代理服务器发起请求，以避免 IP 封锁。
    2.  **添加日志**: 使用 `logging` 模块，在关键步骤（如开始抓取、抓取成功/失败、重试）记录详细日志，便于问题排查。
    3.  **完善配置**: 将所有可变参数（如超时时间、重试次数、目标 URL）移入配置文件。
*   **产出**: 一个接近生产环境要求、健壮且易于维护的抓取应用。